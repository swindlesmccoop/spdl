#!/bin/bash

if [[ -f $HOME/.config/spdl/songs.dir ]]; then
    SONGS=$(cat "$HOME/.config/spdl/songs.dir")
else
    mkdir "$HOME/.config/spdl/"
    touch "$HOME/.config/spdl/songs.dir"
    echo "Please place the path to your Songs directory (WITHOUT A TRAILING SLASH) in ~/.config/spdl/songs.dir"
fi

function search {
    printf "Searching for '$2', please hold...\n\n"
    TERM=$(echo "$2" | sed -e "s/ /%20/g" | sed -e "s/#/%23/g" | sed -e "s/\^/%5E/g")
    RESULT=$(curl -s "https://search.stepmaniaonline.net/packs/$TERM" | grep -o -P '(?<=/link/).*(?=.zip)')
    if [ "$RESULT" == "" ]; then echo "No results found!"; else printf "$RESULT\n\n"; fi
}

function ddl {
    PACK=$(echo "$2" | sed -e "s/ /%20/g" | sed -e "s/#/%23/g" | sed -e "s/\^/%5E/g")
    printf "Download starting, this may take a while. You will receive a notification when the download is complete.\n\n"
    curl -L "https://search.stepmaniaonline.net/static/new/$PACK.zip" -o "$2.zip"
    notify-send "Your download of $2 is complete" &
    unzip -qq "$2.zip" > /dev/null 2>&1
    rm "$2.zip"
    mv "$2" $SONGS/
}

function spdl_help {
    printf 'StepMania Pack Downloader (spdl) by swindlesmccoop\n\nUsage: spdl [-dhs] "[pack]"\n-d, --download: (D)ownload [pack]\n-h, --help: Print this (h)elp message\n-s, --search: (S)earch for a [pack] through the StepManiaOnline.net pack repository\n\nPLEASE READ: WHEN SUPPLYING INPUT, ALWAYS PUT SAID INPUT IN DOUBLE QUOTES\n' && exit 1
}

#if no parameters are supplied, print help
if [ $# -eq 0 ]; then spdl_help; fi

case "$1" in
    -d) ddl "$@" ;;
    --download) ddl "$@" ;;
    -h) spdl_help ;;
    --help) spdl_help ;;
    -s) search "$@" ;;
    --search) search "$@" ;;
    esac

